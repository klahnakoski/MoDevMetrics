<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
    <script type="text/javascript" src="modevlib/Settings.js"></script>
</HEAD>
<BODY>


<script type="application/javascript" src="lib/webdetails/cdf/Base.js"></script>
<script type="application/javascript" src="lib/jquery.js"></script>
<script type="application/javascript" src="lib/jstree/jquery.jstree.js"></script>
<script type="application/javascript" src="lib/webdetails/cdf/jquery.tooltip.js"></script>

<script type="application/javascript" src="lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="application/javascript" src="lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="application/javascript" src="lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" rel="stylesheet" href="lib/webdetails/lib/tipsy.css"/>

<script type="application/javascript" src="lib/webdetails/pvc/pvc.js"></script>
<script type="application/javascript" src="lib/webdetails/pvc/pvcPanel.js"></script>
<script type="application/javascript" src="lib/webdetails/pvc/pvcLegend.js"></script>
<script type="application/javascript" src="lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="application/javascript" src="lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="application/javascript" src="lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="application/javascript" src="lib/webdetails/pvc/pvcPie.js"></script>
<script type="application/javascript" src="lib/webdetails/pvc/pvcBar.js"></script>
<script type="application/javascript" src="lib/webdetails/pvc/pvcLine.js"></script>
<script type="application/javascript" src="lib/webdetails/pvc/pvcData.js"></script>

<link type="text/css" rel="stylesheet" href="lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="lib/webdetails/pvcComponent.css"/>

<script type="application/javascript" src="lib/webdetails/pvcDocUtils.js"></script>


<link type="text/css" rel="stylesheet" href="lib/jquery-ui/css/start/jquery-ui-1.10.2.custom.css"/>
<script type="application/javascript" src="lib/jquery-ui/js/jquery-ui-1.10.2.custom.js"></script>
<script type="application/javascript" src="lib/jquery.ba-bbq/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="css/menu.css"/>


<script type="text/javascript" src="modevlib/util/aUtil.js"></script>
<script type="text/javascript" src="modevlib/collections/aArray.js"></script>
<script type="text/javascript" src="modevlib/util/aString.js"></script>
<script type="text/javascript" src="modevlib/math/aMath.js"></script>
<script type="text/javascript" src="modevlib/util/convert.js"></script>
<script type="text/javascript" src="modevlib/util/aUtil.js"></script>
<script type="text/javascript" src="modevlib/collections/aArray.js"></script>
<script type="text/javascript" src="modevlib/util/aString.js"></script>
<script type="text/javascript" src="modevlib/math/aMath.js"></script>
<script type="text/javascript" src="modevlib/util/aDate.js"></script>
<script type="text/javascript" src="modevlib/util/aDuration.js"></script>

<script type="text/javascript" src="modevlib/MozillaPrograms.js"></script>
<script type="application/javascript" src="modevlib/Dimension.js"></script>
<script type="application/javascript" src="modevlib/Dimension-Bugzilla.js"></script>
<script type="text/javascript" src="modevlib/rest/BugzillaClient.js"></script>
<script type="text/javascript" src="modevlib/Bugzilla.js"></script>

<script type="text/javascript" src="modevlib/math/Stats.js"></script>
<script type="text/javascript" src="modevlib/debug/aLog.js"></script>
<script type="text/javascript" src="modevlib/qb/MVEL.js"></script>
<script type="text/javascript" src="modevlib/qb/aCompiler.js"></script>
<script type="text/javascript" src="modevlib/Hierarchy.js"></script>

<script type="text/javascript" src="modevlib/threads/thread.js"></script>
<script type="text/javascript" src="modevlib/qb/qb.js"></script>
<script type="text/javascript" src="modevlib/qb/qb.analytic.js"></script>
<script type="text/javascript" src="modevlib/qb/qb.aggregate.js"></script>
<script type="text/javascript" src="modevlib/qb/qb.column.js"></script>
<script type="text/javascript" src="modevlib/qb/qb.cube.js"></script>
<script type="text/javascript" src="modevlib/qb/qb.domain.js"></script>
<script type="text/javascript" src="modevlib/rest/Rest.js"></script>
<script type="text/javascript" src="modevlib/qb/ESQuery.js"></script>
<script type="text/javascript" src="modevlib/charts/aChart.js"></script>
<script type="text/javascript" src="modevlib/rest/ElasticSearch.js"></script>
<script type="text/javascript" src="modevlib/gui/Filter.js"></script>
<script type="text/javascript" src="modevlib/gui/ComponentFilter.js"></script>
<script type="text/javascript" src="modevlib/gui/TeamFilter.js"></script>
<script type="text/javascript" src="modevlib/gui/ProductFilter.js"></script>

<script type="text/javascript" src="modevlib/gui/ProgramFilter.js"></script>

<script type="text/javascript" src="modevlib/gui/GUI.js"></script>
<script type="text/javascript" src="modevlib/util/aTimer.js"></script>


<div id="sidebar" style="width:300px;">
    <div style="height: 30px; text-align: center;vertical-align:middle;">
        <span id="status" style="height:30px">Page Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
    </div>

    <hr>
    <div id="description"></div>
    <hr>
    <div id="testMessage"></div>
    <hr>
    <div id="stats"></div>
    <hr>
    <div id="parameters" class="parameters">
    </div>
    <div id="filters" class="menu"></div>
</div>

<div style="float:right;display: inline;">
    <a href="http://people.mozilla.com/~klahnakoski/" class="button">HOME</a>
</div>


<div style="align:left;position:relative;float:left;width:800px;">
    <h3 id="title"></h3>

    <div id="chart" class="chart" style="height:400px;width:800px;"></div>
    <br><br>

    <div id="timechart" class="chart" style="height:400px;width:800px;"></div>

    <div id="sheet"></div>
    <div id="info"></div>
    <div id="report"></div>
</div>

<script type="application/javascript">


var CUTOFF=Duration.newInstance("3week");
$("#description").html("This chart includes all bugs <i>identified</i> in the given sample size, ending on Stats End Date. For closed bugs, the duration is defined from the time the bug is identified, to the time the bug is closed. For open bugs, the duration is defined from the time the bug is identified, to the end of today (GMT). These durations are partitioned into weeks, counted, and charted here.<br><br>Percentile ages includes <i>both</i> ages of open and closed bugs that have been identified in the given sample size, ending on the date shown");

var allBugs;


var thread;
var threadPercentiles;

var createChart=function(){
if (thread!==undefined) thread.kill();
if (threadPercentiles!==undefined) threadPercentiles.kill();
thread=Thread.run( __createChart());
};

var __createChart = function*(){

var sampleSize=Duration.newInstance(GUI.state.sampleSize);
var sampleMax=Date.newInstance(GUI.state.endX).ceilingDay();
var sampleMin=sampleMax.subtract(sampleSize);
var startX=Date.newInstance(GUI.state.startX);
var endX=Date.newInstance(GUI.state.endX);


$("#title").html("Time to Resolution over Time ("+sampleSize.toString()+" sample)");

var idTime=GUI.state.programFilter.bugStatusMinimum_fromDoc();
var closeTime="minimum("+sampleMax.getMilli()+", coalesce(zero2null(doc[\"close_time\"].value), "+sampleMax.getMilli()+"))";


var a=Log.action("Download Times", true);
var durations=yield(ESQuery.run({
"from":"bug_summary",
"select":
{"name":"count", "value":"bug_id", "aggregate":"count"}
,
"edges":[
{"name":"bug_status", "value":closeTime+" < "+sampleMax.getMilli()+" ? \"Closed\" : \"Open\""},
{"name":"duration", "value":closeTime+"-"+idTime, "allowNulls":true, "domain":{"type":"duration", "min":"0", "max":GUI.state.chartMax, "interval":Duration.WEEK}}
],
"esfilter":{"and":[
{"script":{"script":sampleMin.getMilli()+" <= "+idTime+" && "+idTime +" < "+sampleMax.getMilli()}},
GUI.state.productFilter.makeFilter(),
GUI.state.componentFilter.makeFilter()
]}
}));
Log.actionDone(a);

Thread.run(function*(){
var average=yield(ESQuery.run({
"from":"bug_summary",
"select":[
{"name":"duration", "value":closeTime+"-"+idTime, "aggregate":"average"}
],
"esfilter":{"and":[
{"script":{"script":sampleMin.getMilli()+" <= "+idTime+" && "+idTime +" < "+sampleMax.getMilli()}},
GUI.state.productFilter.makeFilter(),
GUI.state.componentFilter.makeFilter()
]}
}));


var stats = (yield(Q({
"from": qb.Cube2List((durations),
"select":[
{"name":"total", "value":"count", "aggregate":"sum"},
{"name":"num_open", "value":"bug_status=='Open' ? count : 0", "aggregate":"sum"},
{"name":"num_closed", "value":"bug_status=='Closed' ? count : 0", "aggregate":"sum"},
{"name":"under", "value":"(duration.value!=null && duration.value.milli<"+CUTOFF.milli+") ? count : 0", "aggregate":"sum"}
]
}))).cube;


$("#stats").html(
'<span class="parameter_name">Total Bugs:</span><b>'+stats.total+'</b><br>'+
'<span class="parameter_name">Bugs Closed per week:</span><b>'+aMath.round(stats.num_closed/(sampleSize.milli/Duration.MILLI_VALUES.week), 0)+'</b><br>'+
'<span class="parameter_name">Open Bugs Remaining:</span><b>'+aMath.round(stats.num_open, 0)+'</b><br>'+
'<span class="parameter_name">% Under '+CUTOFF.toString()+'</span><b>'+aMath.round(stats.under/stats.total*100, 1)+'%</b><br>'+
'<span class="parameter_name">Average Time Open:</span><b>'+aMath.round(average.cube.duration/Duration.MILLI_VALUES.day, 2)+'days</b><br>'
);


});


threadPercentiles=Thread.run(function*(){

var a=Log.action("Get Time Stats", true);
allBugs=yield(ESQuery.run({
"from":"bug_summary",
"select":[
{"value":"bug_id"},
{"name":"birth", "value":GUI.state.programFilter.bugStatusMinimum_fromDoc()},
{"name":"death", "value":closeTime}
],
"esfilter":{"and":[
{"range":Map.newInstance(GUI.state.programFilter.bugStatusMinimum(), {"gte":startX.subtract(sampleSize).getMilli(), "lt":endX.getMilli()})},
GUI.state.productFilter.makeFilter(),
GUI.state.componentFilter.makeFilter()
]}
// "sort":[birth]
}));
Log.actionDone(a);


chartStat(
"Percentile Age (days)",
{"type":"time", "min":startX, "max":endX, "interval":Duration.newInstance(GUI.state.intervalX)},
sampleSize
);


// $("#90").click(function(){
// chartStat(
// "Percentiles days)",
// {"type":"time", "min":startX, "max":endX, "interval":Duration.newInstance(GUI.state.intervalX)},
// sampleSize
// );
// });

});


durations.edges[1].domain.NULL.name="Over "+aMath.floor(Duration.newInstance(GUI.state.chartMax).divideBy(Duration.WEEK))+"weeks";

a=Log.action("Make chart", true);
aChart.show({
"id":"chart",
"sheetDiv":"sheet",
"type":"bar",
"stacked":true,
"cube":durations,
"height":400,
"width":800
});
Log.actionDone(a);


};

var chartStat=function(description, timeDomain, sampleSize){

if (allBugs==null) Log.error("Please wait for data collection");

Thread.run(function*(){

//SOME BUGS HAVE NEGATIVE AGE!!
allBugs.list=allBugs.list.mapExists(function(v, i){
if (v.birth
<v.death
) return v
});
// for(var b=0;b<allBugs.list.length;b++){
// if (allBugs.list[b].birth>allBugs.list[b].death)
// allBugs.list[b].death=allBugs.list[b].birth+Duration.DAY.milli;
//// Log.error();
// }//for
yield (Thread.yield());

// Stats.calc2List({
// "from":allBugs,
// "select":[
// {"name":"average", "value":"Duration.newInstance(death-birth)", "aggregate":"average", "window":sampleSize},
// {"name":"_25_", "value":"Duration.newInstance(aMath.min(death, time.min.getMilli())-birth)", "aggregate":"percentile", "percentile":0.25, "window":sampleSize},
// {"name":"_50_", "value":"Duration.newInstance(aMath.min(death, time.min.getMilli())-birth)", "aggregate":"percentile", "percentile":0.5, "window":sampleSize},
// {"name":"_90_", "value":"Duration.newInstance(aMath.min(death, time.min.getMilli())-birth)", "aggregate":"percentile", "percentile":0.9, "window":sampleSize}
// ],
// "edges":[
// {"name":"birth_date", "value":"Date.newInstance(birth)", domain:timeDomain}
// ]
// });

var values=Stats.ageOverTime(
allBugs.list,
timeDomain,
sampleSize,
function(values){
return Stats.percentiles(values, [
{"name":"_25_", "percentile":0.25},
{"name":"_50_", "percentile":0.5},
{"name":"_90_", "percentile":0.9}
]);
}
);

timeDomain.value="value";
values=yield (Q({
"name":description,
"from":values,
"select":[
{"name":"25percentile", "value":"aMath.round(Duration.newInstance(_25_).milli/Duration.DAY.milli,1)"},
{"name":"50percentile", "value":"aMath.round(Duration.newInstance(_50_).milli/Duration.DAY.milli,1)"},
{"name":"90percentile", "value":"aMath.round(Duration.newInstance(_90_).milli/Duration.DAY.milli,1)"}
],
"edges":[
{"value":"time", "domain":timeDomain}
]
}));

yield (Thread.yield());


$("#stats").append(
'<span class="parameter_name">90th percentile Age:</span><span id="90">'+values.cube[values.cube.length-1]["90percentile"]+'days</span><br>'
);


a=Log.action("Make chart", true);
aChart.show({
"id":"timechart",
"sheetDiv":"sheet",
"type":"line",
"stacked":false,
"cube":values,
"height":400,
"width":800
});
Log.actionDone(a);

});


};


$(document).ready(function(){
GUI.setup(createChart, [
{"id":"sampleSize", "name":"Sample Size", "type":"duration", "default":Duration.newInstance("18week")},
{"id":"chartMax", "name":"Max X-axis on Chart", "type":"duration", "default":Duration.newInstance("3month")},
{"id":"startX", "name":"Stats Start Date", "type":"time", "default":Date.eod().add("-1month")},
{"id":"endX", "name":"Stats End Date", "type":"time", "default":Date.today()},
{"id":"intervalX", "name":"Stats Interval", "type":"duration", "default":Duration.DAY}
],
[
"endX=GUI.fixEndDate(startX, endX, intervalX).format('yyyy-MM-dd')"
],
"bug_summary");
});

</script>


</BODY>
</HTML>

